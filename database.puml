@startuml
title Database Schema - Trust-Based System

entity "trust_relations" {
    * id : BIGSERIAL <<PK>>
    --
    * truster_admin_id : VARCHAR(255)
    * truster_platform : VARCHAR(50)
    * trusted_admin_id : VARCHAR(255)
    * trusted_platform : VARCHAR(50)
    * auto_sync : BOOLEAN
    * sync_ban_type : VARCHAR(50)
    * require_confirmation : BOOLEAN
    * created_at : TIMESTAMP
    * updated_at : TIMESTAMP
    * is_active : BOOLEAN
    --
    UNIQUE(truster_admin_id, truster_platform, trusted_admin_id, trusted_platform)
    CHECK(truster â‰  trusted)
    INDEX(truster_admin_id, truster_platform)
    INDEX(trusted_admin_id, trusted_platform)
}

entity "trust_target_chats" {
    * id : BIGSERIAL <<PK>>
    --
    * trust_relation_id : BIGINT <<FK>>
    * platform : VARCHAR(50)
    * platform_chat_id : VARCHAR(255)
    * created_at : TIMESTAMP
    --
    UNIQUE(trust_relation_id, platform, platform_chat_id)
    INDEX(trust_relation_id)
}

entity "admin_chat_relations" {
    * id : BIGSERIAL <<PK>>
    --
    * admin_id : VARCHAR(255)
    * platform : VARCHAR(50)
    * platform_chat_id : VARCHAR(255)
    * role : VARCHAR(50)
    * can_ban : BOOLEAN
    * can_delete_messages : BOOLEAN
    * is_active : BOOLEAN
    * created_at : TIMESTAMP
    * updated_at : TIMESTAMP
    last_verified_at : TIMESTAMP
    --
    UNIQUE(admin_id, platform, platform_chat_id)
    INDEX(admin_id, platform)
    INDEX(platform, platform_chat_id)
}

entity "ban_events" {
    * id : BIGSERIAL <<PK>>
    --
    * event_id : VARCHAR(255) <<UNIQUE>>
    * platform : VARCHAR(50)
    * platform_user_id : VARCHAR(255)
    * platform_chat_id : VARCHAR(255)
    * initiator_admin_id : VARCHAR(255)
    * initiator_platform : VARCHAR(50)
    * ban_type : VARCHAR(50)
    ban_duration : BIGINT
    reason : TEXT
    * event_timestamp : TIMESTAMP
    * created_at : TIMESTAMP
    metadata : JSONB
    --
    INDEX(initiator_admin_id, initiator_platform, event_timestamp)
    INDEX(platform, platform_user_id, event_timestamp)
    INDEX(platform, platform_chat_id, event_timestamp)
}

entity "sync_logs" {
    * id : BIGSERIAL <<PK>>
    --
    * ban_event_id : BIGINT <<FK>>
    trust_relation_id : BIGINT <<FK, nullable>>
    * source_admin_id : VARCHAR(255)
    * source_platform : VARCHAR(50)
    * source_chat_id : VARCHAR(255)
    * target_platform : VARCHAR(50)
    * target_chat_id : VARCHAR(255)
    * target_admin_id : VARCHAR(255)
    * banned_user_id : VARCHAR(255)
    * status : VARCHAR(50)
    error_message : TEXT
    * retry_count : INT
    started_at : TIMESTAMP
    completed_at : TIMESTAMP
    * created_at : TIMESTAMP
    --
    INDEX(ban_event_id)
    INDEX(trust_relation_id)
    INDEX(status, created_at)
}

trust_relations ||--o{ trust_target_chats : has
ban_events ||--o{ sync_logs : triggers
trust_relations ||--o{ sync_logs : relates_to
admin_chat_relations }o--|| trust_relations : truster_owns_chats
admin_chat_relations }o--|| ban_events : initiator_admin

note right of trust_relations
  Admin A trusts Admin B.
  When B bans someone,
  sync to A's target chats.
end note

note right of trust_target_chats
  If empty for a trust_relation,
  sync to ALL truster's chats.
end note

note right of admin_chat_relations
  Tracks which admins
  manage which chats.
  Used for self-sync.
end note

note right of ban_events
  CRITICAL: Must store
  initiator_admin_id
  to enable trust-based sync.
end note

note right of sync_logs
  trust_relation_id is NULL
  for self-sync operations.
end note

@enduml