@startuml
title Trust-Based Ban Synchronization Flow

actor "Admin B" as adminB
participant "Telegram" as telegram
participant "Telegram\nAdapter" as adapter
participant "Ban Event\nService" as ban_svc
participant "Sync\nService" as sync_svc
participant "Admin Chat\nRepo" as admin_repo
participant "Trust Relation\nRepo" as trust_repo
participant "Sync Log\nRepo" as log_repo
participant "Target Platform\nAdapter" as target
participant "Notification\nService" as notif

== Prerequisite: Trust Setup ==
note over adminB
Admin A previously created:
TrustRelation(Admin A â†’ Admin B)
Target: [Chat X, Chat Y]

Admin B manages: [Chat Z, Chat W]
end note

== Ban Event ==
adminB -> telegram: Ban User123 in Chat Z
activate telegram

telegram -> adapter: ChatMemberUpdated\n{from: Admin B, user: User123}
activate adapter

adapter -> adapter: Extract initiator_admin_id\n= Admin B (123456)

adapter -> ban_svc: RegisterBanEvent(\n  user=User123,\n  chat=Chat Z,\n  initiator=Admin B)
activate ban_svc

ban_svc -> ban_svc: Save BanEventRecord\n(initiator_admin_id = "123456")

ban_svc -> sync_svc: ProcessBanEvent(event_id=42)
activate sync_svc

== Phase 1: Self-Sync (Admin B's Own Chats) ==
note right of sync_svc
Admin B banned in Chat Z.
Self-sync to his other chats.
end note

sync_svc -> admin_repo: GetAdminChats(Admin B)
activate admin_repo
admin_repo --> sync_svc: [Chat Z, Chat W]
deactivate admin_repo

sync_svc -> sync_svc: Filter out source Chat Z

loop Self-sync to Chat W
    sync_svc -> log_repo: Create SyncLog\n(trust_relation_id=NULL)
    activate log_repo
    deactivate log_repo
    
    sync_svc -> target: BanUser(Chat W, User123)
    activate target
    target --> sync_svc: Success
    deactivate target
    
    sync_svc -> log_repo: Update(status=success)
    activate log_repo
    deactivate log_repo
end

== Phase 2: Trust-Sync (Admin A Trusts Admin B) ==
note right of sync_svc
Find who trusts Admin B
and sync to their chats.
end note

sync_svc -> trust_repo: GetTrustersOfAdmin(Admin B)
activate trust_repo
trust_repo --> sync_svc: [TrustRelation(\n  truster=Admin A,\n  trusted=Admin B,\n  target_chats=[X,Y])]
deactivate trust_repo

loop For TrustRelation
    sync_svc -> trust_repo: GetTargetChats(trust_id)
    activate trust_repo
    trust_repo --> sync_svc: [Chat X, Chat Y]
    deactivate trust_repo
    
    loop For each target chat
        sync_svc -> log_repo: Create SyncLog\n(trust_relation_id=5)
        activate log_repo
        deactivate log_repo
        
        sync_svc -> target: BanUser(Chat X, User123)
        activate target
        target --> sync_svc: Success
        deactivate target
        
        sync_svc -> log_repo: Update(status=success)
        activate log_repo
        deactivate log_repo
    end
end

sync_svc --> ban_svc: Sync completed
deactivate sync_svc

== Notifications ==
ban_svc -> notif: NotifySyncCompleted
activate notif

notif -> notif: Format messages:\n"User123 banned in 3 chats"

notif -> adapter: SendMessage(Admin A)
notif -> adapter: SendMessage(Admin B)

deactivate notif
deactivate ban_svc
deactivate adapter
deactivate telegram

@enduml