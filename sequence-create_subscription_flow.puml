@startuml
title Create Subscription Flow

actor Admin as admin
participant "API Gateway" as api_gw
participant "Subscription\nService" as sub_svc
participant "User\nRepository" as user_repo
participant "Subscription\nRepository" as sub_repo
participant "Cache\n(Redis)" as cache
participant "PostgreSQL" as db

admin -> api_gw: POST /api/v1/subscriptions\n{adminID, trackedUserID}
activate api_gw

api_gw -> api_gw: Validate JWT token
api_gw -> api_gw: Validate admin permissions

api_gw -> sub_svc: CreateSubscription(ctx, req)
activate sub_svc

sub_svc -> sub_svc: Validate business rules\n(can't subscribe to self)

sub_svc -> sub_repo: CountByAdmin(adminID)
activate sub_repo
sub_repo -> db: SELECT COUNT(*) WHERE admin_id=?
activate db
db --> sub_repo: count=45
deactivate db
sub_repo --> sub_svc: 45
deactivate sub_repo

sub_svc -> sub_svc: Check limit (45 < 100) âœ“

sub_svc -> user_repo: GetByID(trackedUserID)
activate user_repo
user_repo -> cache: GET user:{platform}:{userID}
activate cache
cache --> user_repo: Cache miss
deactivate cache

user_repo -> db: SELECT * FROM users WHERE...
activate db
db --> user_repo: user data
deactivate db

user_repo -> cache: SET user:{platform}:{userID}
activate cache
deactivate cache
user_repo --> sub_svc: *UnifiedUser
deactivate user_repo

sub_svc -> sub_svc: User exists âœ“

sub_svc -> sub_repo: Create(subscription)
activate sub_repo
sub_repo -> db: INSERT INTO subscriptions...
activate db
db --> sub_repo: id=123
deactivate db
sub_repo --> sub_svc: *Subscription{ID: 123}
deactivate sub_repo

sub_svc -> cache: DELETE subscription:admin:{adminID}
activate cache
note right: Invalidate cache
deactivate cache

sub_svc --> api_gw: *Subscription, nil
deactivate sub_svc

api_gw --> admin: 201 Created\n{"id": 123, "admin_id": "...", ...}
deactivate api_gw

@enduml